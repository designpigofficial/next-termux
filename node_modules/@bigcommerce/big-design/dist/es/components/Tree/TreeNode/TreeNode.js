import _extends from "@babel/runtime/helpers/esm/extends";
import _asyncToGenerator from "@babel/runtime/helpers/esm/asyncToGenerator";
import _regeneratorRuntime from "@babel/runtime/regenerator";
import { CheckIcon, ChevronRightIcon, FolderIcon } from '@bigcommerce/big-design-icons';
import React, { useCallback, useContext, useEffect, useMemo, useRef } from 'react';
import { typedMemo } from '../../../utils';
import { StyledCheckbox } from '../../Checkbox/private';
import { StyledRadio } from '../../Radio/styled';
import { useSelectedChildrenCount } from '../hooks/useSelectedChildrenCount';
import { StyledUl } from '../styled';
import { TreeContext } from '../Tree';
import { StyledArrowWrapper, StyledFlex, StyledFlexItem, StyledGap, StyledLi, StyledSelectableWrapper, StyledText } from './styled';
var flexItemProps = {
  flexShrink: 0,
  marginLeft: 'xxSmall'
};

var InternalTreeNode = function InternalTreeNode(_ref) {
  var _selectable$selectedN;

  var children = _ref.children,
      icon = _ref.icon,
      label = _ref.label,
      value = _ref.value,
      id = _ref.id;

  var _useContext = useContext(TreeContext),
      disabledNodes = _useContext.disabledNodes,
      expandable = _useContext.expandable,
      focusable = _useContext.focusable,
      iconless = _useContext.iconless,
      onKeyDown = _useContext.onKeyDown,
      onNodeClick = _useContext.onNodeClick,
      selectable = _useContext.selectable;

  var nodeRef = useRef(null);
  var selectableRef = useRef(null);
  var isExpanded = expandable.expandedNodes.includes(id);
  var isSelected = selectable === null || selectable === void 0 ? void 0 : (_selectable$selectedN = selectable.selectedNodes) === null || _selectable$selectedN === void 0 ? void 0 : _selectable$selectedN.includes(id);
  var isDisabled = disabledNodes === null || disabledNodes === void 0 ? void 0 : disabledNodes.includes(id);
  var isSelectable = value !== undefined && (selectable === null || selectable === void 0 ? void 0 : selectable.type) !== undefined && !isDisabled;
  var selectedChildrenCount = useSelectedChildrenCount({
    selectedNodes: selectable === null || selectable === void 0 ? void 0 : selectable.selectedNodes,
    children: children
  });
  useEffect(function () {
    if (focusable.focusedNode === id && nodeRef.current !== document.activeElement && document.activeElement !== document.body) {
      var _nodeRef$current;

      (_nodeRef$current = nodeRef.current) === null || _nodeRef$current === void 0 ? void 0 : _nodeRef$current.focus();
    }
  }, [focusable, id]); // Could be multiple elements in which are clicked.
  // Typing to generic Element type since all other elements extend from it.

  var handleNodeToggle = useCallback( /*#__PURE__*/function () {
    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(e) {
      var _selectableRef$curren;

      return _regeneratorRuntime.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              if (!((e === null || e === void 0 ? void 0 : e.target) instanceof Node && (_selectableRef$curren = selectableRef.current) !== null && _selectableRef$curren !== void 0 && _selectableRef$curren.contains(e === null || e === void 0 ? void 0 : e.target) || children === undefined)) {
                _context.next = 2;
                break;
              }

              return _context.abrupt("return");

            case 2:
              if (typeof expandable.onToggle === 'function') {
                expandable.onToggle(id, isExpanded);
              }

              if (isExpanded) {
                if (typeof expandable.onCollapse === 'function') {
                  expandable.onCollapse(id);
                }
              } else {
                if (typeof expandable.onExpand === 'function') {
                  expandable.onExpand(id);
                }
              }

            case 4:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));

    return function (_x) {
      return _ref2.apply(this, arguments);
    };
  }(), [children, id, expandable, isExpanded]);
  var handleNodeSelected = useCallback(function () {
    if (!isSelectable) {
      return;
    }

    if (typeof (selectable === null || selectable === void 0 ? void 0 : selectable.onSelect) === 'function') {
      selectable.onSelect(id, value);
    }
  }, [id, isSelectable, selectable, value]);
  var handleKeyEvent = useCallback(function (e) {
    if (e.altKey || e.currentTarget !== e.target) {
      return;
    }

    onKeyDown(e, {
      id: id,
      isExpanded: isExpanded,
      isSelectable: isSelectable,
      hasChildren: !!(children !== null && children !== void 0 && children.length),
      value: value
    });
  }, [children, id, isExpanded, isSelectable, onKeyDown, value]);
  var handleNodeClick = useCallback(function (e) {
    // Prevents event bubbling
    e.stopPropagation();

    if (typeof focusable.onFocus === 'function') {
      focusable.onFocus(id);
    }

    if (typeof onNodeClick === 'function') {
      onNodeClick(e, id);
    }
  }, [focusable, id, onNodeClick]);
  var additionalProps = useMemo(function () {
    return selectable !== null && selectable !== void 0 && selectable.type ? {
      'aria-selected': isSelected
    } : {};
  }, [selectable, isSelected]);
  var renderedArrow = useMemo(function () {
    return children ? /*#__PURE__*/React.createElement(StyledArrowWrapper, {
      expanded: isExpanded,
      flexShrink: 0
    }, /*#__PURE__*/React.createElement(ChevronRightIcon, {
      color: "secondary60",
      focusable: false,
      size: "xLarge"
    })) : /*#__PURE__*/React.createElement(StyledGap, null);
  }, [children, isExpanded]);
  var renderedChildren = useMemo(function () {
    return children && /*#__PURE__*/React.createElement(StyledUl, {
      role: "group",
      show: isExpanded
    }, children === null || children === void 0 ? void 0 : children.map(function (child, index) {
      return /*#__PURE__*/React.createElement(TreeNode, _extends({}, child, {
        key: index
      }));
    }));
  }, [children, isExpanded]);
  var renderedIcon = useMemo(function () {
    if (iconless) {
      return null;
    }

    return icon ? /*#__PURE__*/React.createElement(StyledFlexItem, flexItemProps, icon) : /*#__PURE__*/React.createElement(StyledFlexItem, flexItemProps, /*#__PURE__*/React.createElement(FolderIcon, {
      color: isDisabled ? 'primary20' : 'primary30',
      size: "xLarge"
    }));
  }, [isDisabled, icon, iconless]);
  var renderedSelectable = useMemo(function () {
    if (value === undefined || !(selectable !== null && selectable !== void 0 && selectable.type)) {
      return null;
    }

    if ((selectable === null || selectable === void 0 ? void 0 : selectable.type) === 'radio') {
      return /*#__PURE__*/React.createElement(StyledSelectableWrapper, flexItemProps, /*#__PURE__*/React.createElement(StyledRadio, {
        "aria-hidden": true,
        checked: isSelected,
        disabled: isDisabled,
        onClick: handleNodeSelected,
        ref: selectableRef
      }));
    }

    if ((selectable === null || selectable === void 0 ? void 0 : selectable.type) === 'multi') {
      return /*#__PURE__*/React.createElement(StyledSelectableWrapper, flexItemProps, /*#__PURE__*/React.createElement(StyledCheckbox, {
        "aria-hidden": true,
        checked: isSelected,
        disabled: isDisabled,
        onClick: handleNodeSelected,
        ref: selectableRef
      }, isSelected ? /*#__PURE__*/React.createElement(CheckIcon, null) : null));
    }
  }, [isDisabled, handleNodeSelected, isSelected, selectable, value]);
  return useMemo(function () {
    return /*#__PURE__*/React.createElement(StyledLi, _extends({
      "aria-expanded": isExpanded,
      onClick: handleNodeClick,
      onKeyDown: handleKeyEvent,
      ref: nodeRef,
      role: "treeitem",
      tabIndex: focusable.focusedNode === id ? 0 : -1
    }, additionalProps), /*#__PURE__*/React.createElement(StyledFlex, {
      alignItems: "center",
      flexDirection: "row",
      onClick: handleNodeToggle,
      selected: isSelected
    }, renderedArrow, renderedSelectable, renderedIcon, /*#__PURE__*/React.createElement(StyledText, {
      as: "span",
      ellipsis: true,
      marginLeft: "xxSmall",
      color: isDisabled ? 'secondary50' : 'secondary70'
    }, label, selectedChildrenCount ? /*#__PURE__*/React.createElement(StyledText, {
      as: "span",
      color: "primary"
    }, ' ', "(", selectedChildrenCount, ")") : null)), renderedChildren);
  }, [additionalProps, handleKeyEvent, handleNodeClick, handleNodeToggle, id, isDisabled, isExpanded, isSelected, focusable, label, renderedArrow, renderedChildren, renderedSelectable, renderedIcon, selectedChildrenCount]);
};

export var TreeNode = typedMemo(InternalTreeNode);